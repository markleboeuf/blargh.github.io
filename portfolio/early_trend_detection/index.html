<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Early Trend Detection</title>
<meta name="description" content="Code and Stuff">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/owl.theme.css">


  <link href="https://markleboeuf.github.io/css/style.red.css" rel="stylesheet" id="theme-stylesheet">


<link href="https://markleboeuf.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://markleboeuf.github.io/img/favicon.png">


</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">Mark LeBoeuf</a></h1>
    
      <p class="sidebar-p">I am a Data Scientist currently based in Portland, OR.</p>
    
    <ul class="sidebar-menu">
      
      
        <li><a href="https://markleboeuf.github.io/">Home</a></li>
      
        <li><a href="https://markleboeuf.github.io/about/">About</a></li>
      
    </ul>
    <p class="social">
  
  
  
  
  
  
  <a href="https://www.linkedin.com/in/markleboeuf/" data-animate-hover="pulse">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
  
  <a href="https://github.com/markleboeuf/markleboeuf.github.io" data-animate-hover="pulse">
    <i class="fa fa-github"></i>
  </a>
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2016 Mark LeBoeuf
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">Mark LeBoeuf</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">
         <h1>Early Trend Detection</h1>
         <p></p>

<p><img src="../counterfactual_prediction_images/counterfactual_example.png" class="img-responsive" style="display: block; margin: auto;" /></p>

<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#souvenir-sales-+-sign-spinning-+-australia">Souvenir Sales + Sign Spinning + Australia</a></li>
<li><a href="#creating-the-synthetic-data-set">Creating the Synthetic Data Set</a></li>
<li><a href="#selecting-a-control-time-series-with-dynamic-time-warping">Selecting a Control Time Series with Dynamic Time Warping</a></li>
<li><a href="#generating-counterfactual-predictions">Generating Counterfactual Predictions</a></li>
</ul>

<h2 id="overview">Overview</h2>

<p>There are some really cool posts on this topic (see here and here to name a few).</p>

<h3 id="predicting-stocks">Predicting Stocks</h3>

<p>Let&rsquo;s get one thing out of the way: This method cannot reliably predict whether a stock will trend upwards or downwards. If it could, I would be not writing this post. In fact, I would&rsquo;ve moved to Connecticut, opened a hedge fund, made a bunch of money, and then went directly to Dairy Queen and purchased every flavor of ice cream cake. Because that&rsquo;s what we&rsquo;d all do following a major cash windfall &ndash; buy/eat all the ice cream.</p>

<p>However, for certain series that exhibit a detectable pattern prior to trending up (down), methods like the one discussed herein can produce some pretty solid results in terms of classifying where a series will likely go in the future.</p>

<h3 id="collecting-stocks-data">Collecting Stocks data</h3>

<p>The data we&rsquo;ll use is the historical daily closing prices for the stocks&rsquo; of all Fortune 500 companies. Let&rsquo;s load up all the libraries and then pull down the list of companies from wikipedia.</p>

<pre><code class="language-r">library(BatchGetSymbols)
library(rvest)
library(Kendall)
library(broom)
library(MarketMatching)

url = &quot;https://en.wikipedia.org/wiki/List_of_S%26P_500_companies&quot;

data = url %&gt;%
  read_html() %&gt;%
  html_nodes(xpath='//*[@id=&quot;mw-content-text&quot;]/table[1]') %&gt;%
  html_table() %&gt;% 
  data.frame()
  
tickers = data[,1]
</code></pre>

<p>Now we have a vector of all 500 companies. This will serve as an input to the next part, which is collecting the historical daily closing prices for all of the stocks. The library to help us do it is <code>BatchGetSymbols</code>. Let&rsquo;s specify a starting and ending date across which we&rsquo;ll collect the closing prices. I picked 2015-01-01 and the 200 days following. One thing to note is that the stock market is closed on weekends and holidays, so it&rsquo;s OK to have days missing (i.e., less than 200 days).</p>

<pre><code class="language-r">train_period_begin = as.Date(&quot;2015-01-01&quot;)
train_period_end = max(seq(train_period_begin, by = &quot;day&quot;, length.out = 200))

stock_data_train = BatchGetSymbols(tickers = tickers,
                                   first.date = train_period_begin,
                                   last.date = train_period_end)
</code></pre>

<p>Everything worked. Now that we have our data, let&rsquo;s go into a little more detail around how we&rsquo;ll set this problem up. First, let&rsquo;s revisit the original question: Can we take 30 days of closing prices and classify where the stock will trend (up, neutral|down) over the next 90 days. We&rsquo;ve limited the number of classes in this example to 2 for the sake of simplicity.</p>

<p>The plots below illustrate what this looks like.</p>

<h4 id="positive-trend">Positive Trend</h4>

<h4 id="neutral-negative-trend">Neutral|Negative Trend</h4>

<p>We&rsquo;ll consider this our &lsquo;training&rsquo; data set, even though we aren&rsquo;t actually training a model. Take the first 30 days of each time series, and then add a label to each: <em>postive</em> or <em>neutral|negative</em>.</p>
         
      </div>
    </div>
  </div>
</div>

          </div>
      </div>
  </div>
  <script src="https://markleboeuf.github.io/js/jquery.min.js"></script>
<script src="https://markleboeuf.github.io/js/bootstrap.min.js"></script>
<script src="https://markleboeuf.github.io/js/jquery.cookie.js"> </script>
<script src="https://markleboeuf.github.io/js/ekko-lightbox.js"></script>
<script src="https://markleboeuf.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://markleboeuf.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://markleboeuf.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://markleboeuf.github.io/js/owl.carousel.min.js"></script>
<script src="https://markleboeuf.github.io/js/front.js"></script>

</body>
</html>
