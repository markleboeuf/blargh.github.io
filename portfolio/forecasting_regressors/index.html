<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Forecasting with External Regressors</title>
<meta name="description" content="Code and Stuff">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/owl.carousel.css">
<link rel="stylesheet" href="https://markleboeuf.github.io/css/owl.theme.css">


  <link href="https://markleboeuf.github.io/css/style.red.css" rel="stylesheet" id="theme-stylesheet">


<link href="https://markleboeuf.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://markleboeuf.github.io/img/favicon.png">


</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">Mark LeBoeuf</a></h1>
    
      <p class="sidebar-p">I am a Data Scientist, currently based in Portland, OR.</p>
    
    <ul class="sidebar-menu">
      
      
        <li><a href="https://markleboeuf.github.io/">Home</a></li>
      
        <li><a href="https://markleboeuf.github.io/about/">About</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="full%20profile%20url%20in%20twitter" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  <a href="full%20profile%20url%20in%20linkedin" data-animate-hover="pulse">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
  
  <a href="full%20profile%20url%20in%20github" data-animate-hover="pulse">
    <i class="fa fa-github"></i>
  </a>
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2016 Mark LeBoeuf
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">Mark LeBoeuf</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">
         <h1>Forecasting with External Regressors</h1>
         <p>This post focuses on some of my favorite things: Data, Sports, and Forecasting. Today we&rsquo;ll discuss how to leverage external regressors when creating forecasts. We&rsquo;ll do some webscraping in R and Python to create our dataset, and then try to forecast how many people will Visit Tom Brady&rsquo;s wikipedia page.
</p>

<p><img src="../forecasting_regressors_images/hey_tom.jpg" class="img-responsive" style="display: block; margin: auto;" /></p>

<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#collecting-month-level-traffic">Collecting Month Level Traffic</a></li>
<li><a href="#collecting-historical-game-data">Collecting Historical Game Data</a></li>
<li><a href="#model-selection-and-validation">Model Selection And Validation</a></li>
</ul>

<h2 id="overview">Overview</h2>

<p>Imagine the following scenario. It&rsquo;s January 1st, 2015 and the New England Patriots have made the playoffs yet again (sigh..). You run a webpage dedicated to Tom Brady and want to ensure you have enough servers ready to meet traffic to your website during the playoffs. Based on the past few years, you&rsquo;ve noticed that traffic during January and February increases when the patriots win their playoff games. Thus you need a traffic forecast for this time period in order to get an idea of how many people will visit your site.</p>

<p>Additionally, you want some insight on the effect of winning 1, 2, or 3 playoff games has on monthly traffic. For example, what happens if the Patriots two playoffs relative to one game? Finally, you want an estimate of the probability of each of these scenarios unfolding&ndash;that is, the Patriots&rsquo; chances of winning 0, 1, 2, or all 3 playoff games. To achieve these objectives, we&rsquo;ll rely on three seperate sources of data:</p>

<ul>
<li>Month Level Internet Traffic</li>
<li>Historical Game Outcomes</li>
<li>Historical Betting Lines</li>
</ul>

<p>I&rsquo;ll go through each of these in turn, and then we&rsquo;ll generate some forecasts!</p>

<h3 id="collecting-month-level-traffic">Collecting Month Level Traffic</h3>

<p>Let&rsquo;s get started by loading of all the libraries we&rsquo;ll need and setting our working directory.</p>

<pre><code class="language-r">
libs = c('wikipediatrend', 'dplyr', 'data.table', 'rvest', 'forecast', 'artyfarty', 'knitr', 'ggplot2', 'forcats', 'lazyeval')
lapply(libs, require, character.only = TRUE)
wd = &quot;your_working_directory_here&quot;
setwd(wd)

</code></pre>

<p>Now we&rsquo;ll collect historical page views. This data comes from Wikipedia and will serve as the dependent variable in our forecast.</p>

<pre><code class="language-r">page_views_by_day &lt;- wp_trend(&quot;Tom Brady&quot;, from = &quot;2006-09-01&quot;,
to = &quot;2015-03-01&quot;)

page_views_clean$date = as.Date(page_views_clean$date)

page_views_clean &lt;- page_views_by_day %&gt;%
                    dplyr::mutate(year = year(date),
                                  month = month(date),
                                  week = week(date)) %&gt;%
                    dplyr::rename(page_views = count) %&gt;%
                    dplyr::select(date, year, month, week, page_views)
</code></pre>

<p>Let&rsquo;s have a look at the first 5 rows</p>

<p><img src="../forecasting_regressors_images/table1.png" class="img-responsive" style="display: block; margin: auto;" /></p>

<h3 id="collecting-historical-game-data">Collecting Historical Game Data</h3>

<p>Looks good! Next we&rsquo;ll collect data on how the New England Patriots have historically performed during the playoffs, and then merge this with our page views data set. I&rsquo;m using the <mark>rvest</mark> package to scrape the outcomes (win or lose) of the patriots vs each of the other 31 NFL teams.</p>

<pre><code class="language-r"> n_teams = 32
 team_name = &quot;new-england-patriots&quot;
 game_data = data.frame(NULL)
 for(team_number in as.character(seq(1, n_teams))){
   print(paste0(&quot;GATHERING DATA FOR TEAM: &quot;, team_number))
   url = paste0(&quot;http://www.footballdb.com/teams/nfl/&quot;,
                team_name,
                &quot;/teamvsteam?opp=&quot;,
                team_number)
   historical_record = url %&gt;% 
     read_html() %&gt;% 
     html_nodes(xpath = '//*[@id=&quot;leftcol&quot;]/div[9]/table') %&gt;% 
     html_table(fill = TRUE, header = TRUE) %&gt;% 
     as.data.frame()
   game_data = rbind(game_data, historical_record) 
}

game_data_clean = game_data %&gt;% 
                  dplyr::rename(date = Date) %&gt;%
                  dplyr::mutate(new_date = substring(date, 1, 10)) %&gt;% 
                  dplyr::mutate(new_date = as.Date(new_date, 
                                format = &quot;%m/%d/%Y&quot;)) %&gt;% 
                  dplyr::arrange(desc(new_date)) %&gt;% 
                  dplyr::select(date, new_date, Result)
</code></pre>

<p>Again let&rsquo;s see what our data looks like:</p>

<p><img src="../forecasting_regressors_images/table2a.png" class="img-responsive" style="display: block; margin: auto;" /></p>

<p>Overall looks pretty good but we still have some cleaning to do. What we want from this data are the dates of the playoff games and their outcome. Luckily there is an asterik delineating regular season games from playoff games, and we&rsquo;ll use this piece of information to identify the playoff games.</p>

<pre><code class="language-r">game_data_outcome = game_data_clean %&gt;% 
                    dplyr::mutate(date_length = nchar(
                                                as.character(date))
                                  ) %&gt;% 
                    dplyr::mutate(playoff_game = ifelse(date_length == 20, 1, 0),
                    result = substring(Result, 1, 1)) %&gt;% 
                    dplyr::mutate(result = ifelse(result == &quot;W&quot;, 1, 0)) %&gt;% 
                    dplyr::select(new_date, playoff_game, result) %&gt;% 
                    dplyr::rename(date = new_date) 

</code></pre>

<p><img src="../forecasting_regressors_images/table2b.png" class="img-responsive" style="display: block; margin: auto;" /></p>

<p>Now we are ready to combine our game data with our traffic data.</p>

<pre><code class="language-r">
joined_df = dplyr::left_join(page_views_clean, game_data_outcome) %&gt;% 
            dplyr::mutate(playoff_game = ifelse(is.na(playoff_game) == TRUE | 
            playoff_game == 0, 0, 1)) %&gt;% 
            dplyr::filter(year &gt; 2007 &amp; year &lt; 2016)

playoff_wins = joined_df %&gt;% 
               dplyr::filter(playoff_game == 1) %&gt;% 
               dplyr::group_by(year) %&gt;% 
               dplyr::summarise(playoff_games_won = sum(result))

playoff_games = joined_df %&gt;% 
                dplyr::group_by(year) %&gt;% 
                dplyr::summarise(playoff_games_played = 
                                 sum(playoff_game)) %&gt;% 
                dplyr::left_join(playoff_wins) %&gt;% 
                data.frame() %&gt;% 
                dplyr::mutate(playoff_games_won = ifelse(is.na(
                                                          playoff_games_won) == TRUE, 0, 
                                                                    playoff_games_won))
joined_df_game = joined_df %&gt;% 
                 dplyr::inner_join(playoff_games) %&gt;% 
                 dplyr::group_by(year, month, 
                                 playoff_games_played, 
                                 playoff_games_won) %&gt;% 
                 dplyr::mutate(month_max_date = max(date)) %&gt;% 
                 dplyr::group_by(year, month, playoff_games_played, 
                                 playoff_games_won, month_max_date) %&gt;% 
                 dplyr::summarise(monthly_page_views = sum(page_views)) %&gt;% 
                 data.frame()

joined_df_game$playoff_games_played = ifelse(joined_df_game$month %in% c(1, 2), 
joined_df_game$playoff_games_played, 0)

joined_df_game$playoff_games_won = ifelse(joined_df_game$month %in% c(1, 2), 
joined_df_game$playoff_games_won, 0)

</code></pre>

<p>And we&rsquo;ll have a look at the first 5 rows:</p>

<p><img src="../forecasting_regressors_images/table4.png" class="img-responsive" style="display: block; margin: auto;" /></p>

<p>Plotting Wins &amp; Page Traffic</p>

<p>Here&rsquo;s how we interpret this. Do we need to know how many they&rsquo;ll plan in or how many they&rsquo;ll win? For example, during Jan/Feb 2008 the Patriots played in all three playoff games but they only won the first two, eventually losing the Super Bowl to New York Giants. Enough talking &ndash; let&rsquo;s plot the relationship between playoff games won and monthly page views.</p>

<pre><code class="language-r">my_plot_theme = function(){
                font_family = &quot;Helvetica&quot;
                font_face = &quot;bold&quot;

                return(theme(
                       axis.text.x = element_text(size = 18, 
                                                  face = font_face, 
                                                  family = font_family),
                       axis.text.y = element_text(size = 18, 
                                                  face = font_face, 
                                                  family = font_family),
                       axis.title.x = element_text(size = 20, 
                                                   face = font_face, 
                                                    family = font_family),
                       axis.title.y = element_text(size = 20, face = font_face, family = font_family),
                       strip.text.y = element_text(size = 18, face = font_face, family = font_family),
                       plot.title = element_text(size = 24, face = font_face, family = font_family),
                       legend.position = &quot;top&quot;,
                       legend.title = element_text(colour = &quot;white&quot;, size = 16,
                       face = font_face,
                       family = font_family),
                       legend.text = element_text(colour = &quot;white&quot;, size = 14,
                       face = font_face,
                       family = font_family)))
}
monokai_values = c(&quot;#F92672&quot;, &quot;#66D9EF&quot;, &quot;#A6E22E&quot;, &quot;#FD971F&quot;)
monokai_line_color = &quot;#A59F85&quot;

train_test_df &lt;- joined_df_game %&gt;% 
                 dplyr::filter(month_max_date &lt;= '2015-02-28') %&gt;% 
                 dplyr::mutate(train_test_flag = ifelse(year &gt; 2014, &quot;test&quot;, &quot;train&quot;))
                               playoff_dates = train_test_df %&gt;% 
                 dplyr::filter(month %in% c(1, 2)) %&gt;% 
                 dplyr::select(month_max_date)


train_df_final = train_test_df %&gt;% 
                 dplyr::filter(train_test_flag == 'train') %&gt;% 
                 dplyr::select(year, month, month_max_date, 
                               playoff_games_won, monthly_page_views)

ggplot(train_df_final, aes(x = month_max_date, y = monthly_page_views/1e3)) + 
geom_line(size = 1, color = monokai_line_color) +
geom_point(aes(color = as.factor(playoff_games_won)), size = 4) + 
theme_monokai_full() + 
scale_color_manual(values = monokai_values[1:3],
guide = guide_legend(title = &quot;Playoff Games Won&quot;)) + 
my_plot_theme() + 
xlab(&quot;Date&quot;) + ylab(&quot;Monthly Page Views (K)&quot;)

</code></pre>

<p><img src="../forecasting_regressors_images/playoff_games_won.png" class="img-responsive" style="display: block; margin: auto;" /></p>

<p>Our initial suspicions are confirmed. Now we&rsquo;ll do some validation to work to see if including an external regressor actually improves our forecasts.</p>

<h3 id="model-selection-and-validation">Model Selection And Validation</h3>

<p>Since the period we want to forecast for is Jan/Feb 2015, we&rsquo;ll hold out the two months of traffic results from Jan/Feb 2014 as a way to identify which inputs will likely yield the most accurate forecasts. We will specify an ARIMA model with a single external regressor (either games played or games won), and compare the results on our validation set against an ARIMA model that relies on history alone.</p>

<pre><code class="language-r"># filter data until last year and create training and validation time periods
train_validation = joined_df_game %&gt;% 
dplyr::filter(month_max_date &lt;= &quot;2014-02-28&quot;) %&gt;% 
dplyr::mutate(train_test_flag = ifelse(year &lt; 2014, &quot;train&quot;, &quot;validation&quot;))

training_df = train_validation %&gt;% 
dplyr::filter(train_test_flag == 'train')

validation_df = train_validation %&gt;% 
dplyr::filter(train_test_flag == 'validation')

# create our time-series object 
page_views_ts = ts(training_df$monthly_page_views, 
frequency = 12,
start = c(head(training_df, 1)$year, 
head(training_df, 1)$month),
end = c(tail(training_df, 1)$year, 
tail(training_df, 1)$month))
# specify that we want to make a forecast 2 periods ahead
prediction_horizon = 2
# arima model with no external regressors
arima_no_xreg = auto.arima(page_views_ts)
arima_no_xreg_f =  data.frame(forecast(arima_no_xreg, 
h = prediction_horizon))
#arima model with playoff games played as an external regessor
arima_games_played = auto.arima(page_views_ts, xreg = training_df$playoff_games_played)
arima_games_played_f = data.frame(forecast(arima_games_played, 
h = prediction_horizon,
xreg = validation_df$playoff_games_played))
#arima model with playoff games won as an external regessor
arima_games_won = auto.arima(page_views_ts, xreg = training_df$playoff_games_won)
arima_games_won_f = data.frame(forecast(arima_games_won, 
h = prediction_horizon,
xreg = validation_df$playoff_games_won))
#
forecast_df = rbind(arima_no_xreg_f,
arima_games_played_f,
arima_games_won_f) %&gt;% 
dplyr::rename(predicted_monthly_views = Point.Forecast) %&gt;% 
dplyr::mutate(forecast_model =
c(rep('No.Xreg', 2), 
rep('Games.Played', 2),
rep('Games.Won',2)
),
actual_monthly_views = rep(validation_df$monthly_page_views, 3)) %&gt;% 
dplyr::select(forecast_model, predicted_monthly_views, actual_monthly_views)
</code></pre>
         
      </div>
    </div>
  </div>
</div>

          </div>
      </div>
  </div>
  <script src="https://markleboeuf.github.io/js/jquery.min.js"></script>
<script src="https://markleboeuf.github.io/js/bootstrap.min.js"></script>
<script src="https://markleboeuf.github.io/js/jquery.cookie.js"> </script>
<script src="https://markleboeuf.github.io/js/ekko-lightbox.js"></script>
<script src="https://markleboeuf.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://markleboeuf.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://markleboeuf.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://markleboeuf.github.io/js/owl.carousel.min.js"></script>
<script src="https://markleboeuf.github.io/js/front.js"></script>

</body>
</html>
